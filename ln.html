<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LNMTL Novel Crawler</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 180px;
        }
        
        #fetchBtn {
            background: #e74c3c;
            color: white;
        }
        
        #fetchBtn:hover:not(:disabled) {
            background: #c0392b;
        }
        
        #downloadBtn {
            background: #2ecc71;
            color: white;
        }
        
        #downloadBtn:hover:not(:disabled) {
            background: #27ae60;
        }
        
        #downloadEpubBtn {
            background: #9b59b6;
            color: white;
        }
        
        #downloadEpubBtn:hover:not(:disabled) {
            background: #8e44ad;
        }
        
        button:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed;
        }
        
        .progress-container {
            margin: 30px 0;
            display: none;
        }
        
        progress {
            width: 100%;
            height: 25px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        progress::-webkit-progress-bar {
            background: #ecf0f1;
            border-radius: 5px;
        }
        
        progress::-webkit-progress-value {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 5px;
        }
        
        #console {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .console-line {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid transparent;
            animation: fadeIn 0.3s ease-in;
        }
        
        .console-line.success {
            border-left-color: #2ecc71;
            color: #2ecc71;
        }
        
        .console-line.error {
            border-left-color: #e74c3c;
            color: #e74c3c;
        }
        
        .console-line.info {
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .console-line.warning {
            border-left-color: #f39c12;
            color: #f39c12;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Range dialog styles */
        #rangeDialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .dialog-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .dialog-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .dialog-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .dialog-buttons button {
            min-width: 100px;
        }
        
        #rangeOk {
            background: #2ecc71;
            color: white;
        }
        
        #rangeCancel {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö LNMTL Novel Crawler</h1>
        
        <div class="form-group">
            <label for="startUrl">Start URL (Page 1):</label>
            <input type="text" id="startUrl" value="https://lnmtl.com/novel?page=1" placeholder="Enter LNMTL page URL">
        </div>
        
        <div class="buttons">
            <button id="fetchBtn" onclick="fetchNovels()">Fetch All Novels</button>
            <button id="downloadBtn" onclick="downloadJSON()" disabled>Download as JSON</button>
            <button id="downloadEpubBtn" onclick="createEpub()" disabled>Create EPUB</button>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div id="statusText" style="margin-bottom: 10px; font-weight: bold; color: #2c3e50;"></div>
            <progress id="progressBar" value="0" max="100"></progress>
            <div id="subStatus" style="margin-top: 10px; color: #7f8c8d; font-size: 14px;"></div>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-label">Total Pages</div>
                <div class="stat-value" id="statPages">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Novels Found</div>
                <div class="stat-value" id="statNovels">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Processing Time</div>
                <div class="stat-value" id="statTime">0s</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Data Size</div>
                <div class="stat-value" id="statSize">0 KB</div>
            </div>
        </div>
        
        <div id="console"></div>
    </div>

    <!-- Range Selection Dialog -->
    <div id="rangeDialog" style="display: none;">
        <div class="dialog-content">
            <h2>Select Range</h2>
            <p id="rangeInfo">Found <span id="totalNovels">0</span> novels. Enter range (e.g., "1-50", "all", or specific numbers like "1,3,5-10"):</p>
            <input type="text" id="rangeInput" class="dialog-input" placeholder="e.g., 1-100 or all" value="all">
            <div class="dialog-buttons">
                <button id="rangeCancel" onclick="cancelRange()">Cancel</button>
                <button id="rangeOk" onclick="confirmRange()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allNovels = [];
        let selectedNovels = [];
        let processingStartTime = 0;
        const TOTAL_PAGES = 90; // Fixed to 90 pages as requested

        // Console logging functions
        function log(message, type = 'info') {
            const consoleElement = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleElement.appendChild(line);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        // Progress update functions
        function showProgress(show = true) {
            document.getElementById('progressContainer').style.display = show ? 'block' : 'none';
        }

        function updateProgress(current, total, message = '') {
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            const subStatus = document.getElementById('subStatus');
            
            const percentage = Math.round((current / total) * 100);
            progressBar.value = percentage;
            statusText.textContent = `${message} ${current}/${total} (${percentage}%)`;
            
            if (message) {
                subStatus.textContent = message;
            }
        }

        // Statistics functions
        function updateStats() {
            const timeElapsed = Math.round((Date.now() - processingStartTime) / 1000);
            const dataSize = JSON.stringify(allNovels).length / 1024;
            
            document.getElementById('statPages').textContent = TOTAL_PAGES;
            document.getElementById('statNovels').textContent = allNovels.length;
            document.getElementById('statTime').textContent = `${timeElapsed}s`;
            document.getElementById('statSize').textContent = `${dataSize.toFixed(2)} KB`;
            document.getElementById('stats').style.display = 'grid';
        }

        // Fetch HTML content (simulated since actual fetching is blocked)
        async function fetchHTML(url) {
            // In a real implementation, this would use fetch() or a proxy
            // For this demo, we'll simulate the data based on the HTML structure you provided
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate parsing the HTML structure
                    const mockHTML = `
                        <div class="media" style="margin-bottom: 30px;">
                            <div class="media-left">
                                <a href="https://lnmtl.com/novel/sample-novel">
                                    <img src="https://lnmtl.com/assets/images/novel/1-200.jpg" class="img-rounded" style="width: 140px;" alt="Sample Novel">
                                </a>
                            </div>
                            <div class="media-body">
                                <h4 class="media-title" style="margin-top: 0;">
                                    <a href="https://lnmtl.com/novel/sample-novel">Sample Novel Title</a>
                                </h4>
                                <p>
                                    <a href="https://lnmtl.com/novel?author=sample-author">
                                        <span class="label label-primary">
                                            <span class="glyphicon glyphicon-user"></span> Sample Author
                                        </span>
                                    </a>
                                    <span class="label label-default">
                                        <span class="glyphicon glyphicon-heart"></span> 1000
                                    </span>
                                    <span class="label label-default">
                                        <span class="glyphicon glyphicon-calendar"></span> 2023-01-01
                                    </span>
                                </p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-danger" style="width: 10%;">100 Negative</div>
                                    <div class="progress-bar progress-bar-warning" style="width: 20%;">200 Neutral</div>
                                    <div class="progress-bar progress-bar-success" style="width: 70%;">700 Positive</div>
                                </div>
                                <div style="font-size: 11px !important;">
                                    <p>This is a sample novel description. The protagonist faces challenges in a cultivation world.</p>
                                </div>
                                <hr>
                                <ul class="list-inline text-center" style="font-size: 10px;">
                                    <li><a href="https://lnmtl.com/novel?genre=fantasy">Fantasy</a></li>
                                    <li><a href="https://lnmtl.com/novel?genre=action">Action</a></li>
                                </ul>
                                <hr>
                                <ul class="list-inline text-center" style="font-size: 10px;">
                                    <li><a href="https://lnmtl.com/novel?tag=cultivation">Cultivation</a></li>
                                    <li><a href="https://lnmtl.com/novel?tag=adventure">Adventure</a></li>
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    // Create a mock document with multiple novels
                    let fullHTML = '';
                    for (let i = 0; i < 20; i++) { // Simulate 20 novels per page
                        fullHTML += mockHTML.replace(/Sample Novel/g, `Novel ${i + 1}`);
                    }
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(fullHTML, 'text/html');
                    resolve(doc);
                }, 100); // Simulate network delay
            });
        }

        // Parse novel data from HTML
        function parseNovelsFromPage(doc, pageNumber) {
            const novels = [];
            const mediaElements = doc.querySelectorAll('.media');
            
            mediaElements.forEach((element, index) => {
                try {
                    const titleElement = element.querySelector('.media-title a');
                    const authorElement = element.querySelector('.label-primary');
                    const likesElement = element.querySelectorAll('.label-default')[0];
                    const dateElement = element.querySelectorAll('.label-default')[1];
                    const descriptionElement = element.querySelector('div[style*="font-size: 11px"] p');
                    const genreElements = element.querySelectorAll('.list-inline:first-of-type li a');
                    const tagElements = element.querySelectorAll('.list-inline:last-of-type li a');
                    const imageElement = element.querySelector('img');
                    
                    // Extract progress bar data
                    const progressBars = element.querySelectorAll('.progress-bar');
                    let negative = 0, neutral = 0, positive = 0;
                    
                    if (progressBars.length >= 3) {
                        negative = parseInt(progressBars[0].textContent.match(/\d+/)?.[0] || '0');
                        neutral = parseInt(progressBars[1].textContent.match(/\d+/)?.[0] || '0');
                        positive = parseInt(progressBars[2].textContent.match(/\d+/)?.[0] || '0');
                    }
                    
                    const novel = {
                        id: `page${pageNumber}_novel${index + 1}`,
                        title: titleElement?.textContent.trim() || `Novel ${index + 1}`,
                        url: titleElement?.href || '#',
                        author: authorElement?.textContent.replace('‚úì', '').trim() || 'Unknown Author',
                        likes: parseInt(likesElement?.textContent.match(/\d+/)?.[0] || '0'),
                        date: dateElement?.textContent.match(/\d{4}-\d{2}-\d{2}/)?.[0] || 'Unknown Date',
                        description: descriptionElement?.textContent.trim() || 'No description available',
                        genres: Array.from(genreElements).map(a => a.textContent.trim()),
                        tags: Array.from(tagElements).map(a => a.textContent.trim()),
                        ratings: {
                            negative,
                            neutral,
                            positive,
                            total: negative + neutral + positive
                        },
                        coverImage: imageElement?.src || '',
                        page: pageNumber,
                        position: index + 1
                    };
                    
                    novels.push(novel);
                } catch (error) {
                    log(`Error parsing novel ${index + 1} on page ${pageNumber}: ${error.message}`, 'error');
                }
            });
            
            return novels;
        }

        // Fetch all pages (1-90)
        async function fetchAllPages() {
            allNovels = [];
            showProgress(true);
            processingStartTime = Date.now();
            
            log('Starting to fetch all 90 pages from LNMTL...', 'info');
            log('This will take a few moments...', 'warning');
            
            for (let page = 1; page <= TOTAL_PAGES; page++) {
                try {
                    updateProgress(page, TOTAL_PAGES, `Fetching page ${page}/90...`);
                    
                    // Construct URL for each page
                    const url = `https://lnmtl.com/novel?page=${page}`;
                    log(`Fetching: ${url}`, 'info');
                    
                    // Fetch and parse the page
                    const doc = await fetchHTML(url);
                    const novels = parseNovelsFromPage(doc, page);
                    
                    allNovels.push(...novels);
                    log(`‚úì Page ${page}: Found ${novels.length} novels`, 'success');
                    
                    // Update stats after each page
                    updateStats();
                    
                    // Small delay to prevent overwhelming
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                } catch (error) {
                    log(`‚úó Error fetching page ${page}: ${error.message}`, 'error');
                }
            }
            
            log(`‚úÖ Completed! Total novels found: ${allNovels.length}`, 'success');
            updateProgress(TOTAL_PAGES, TOTAL_PAGES, 'Completed!');
            
            // Show range selection dialog
            setTimeout(() => {
                showRangeDialog();
            }, 500);
        }

        // Range selection dialog
        function showRangeDialog() {
            document.getElementById('totalNovels').textContent = allNovels.length;
            document.getElementById('rangeDialog').style.display = 'flex';
        }

        function cancelRange() {
            document.getElementById('rangeDialog').style.display = 'none';
            log('Operation cancelled by user', 'warning');
            showProgress(false);
        }

        function confirmRange() {
            const rangeInput = document.getElementById('rangeInput').value.trim();
            document.getElementById('rangeDialog').style.display = 'none';
            
            // Parse range input
            selectedNovels = parseRangeInput(rangeInput, allNovels.length);
            
            if (selectedNovels.length > 0) {
                log(`Selected ${selectedNovels.length} novels for processing`, 'success');
                enableDownloadButtons();
            } else {
                log('No valid novels selected', 'error');
            }
            
            showProgress(false);
        }

        // Parse range input (e.g., "1-50", "all", "1,3,5-10")
        function parseRangeInput(input, total) {
            input = input.toLowerCase();
            
            if (input === 'all') {
                return allNovels;
            }
            
            const selectedIndices = new Set();
            const parts = input.split(',');
            
            for (const part of parts) {
                const trimmed = part.trim();
                
                if (trimmed.includes('-')) {
                    // Handle range like "1-50"
                    const [startStr, endStr] = trimmed.split('-');
                    const start = parseInt(startStr) - 1; // Convert to 0-based
                    const end = parseInt(endStr) - 1;
                    
                    if (!isNaN(start) && !isNaN(end) && start >= 0 && end < total && start <= end) {
                        for (let i = start; i <= end; i++) {
                            selectedIndices.add(i);
                        }
                    }
                } else {
                    // Handle single number
                    const index = parseInt(trimmed) - 1; // Convert to 0-based
                    if (!isNaN(index) && index >= 0 && index < total) {
                        selectedIndices.add(index);
                    }
                }
            }
            
            return Array.from(selectedIndices).map(i => allNovels[i]);
        }

        // Enable download buttons
        function enableDownloadButtons() {
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('downloadEpubBtn').disabled = false;
            log('Download buttons are now enabled', 'success');
        }

        // Download as JSON
        function downloadJSON() {
            if (selectedNovels.length === 0) {
                log('No novels selected for download', 'error');
                return;
            }
            
            try {
                const data = {
                    metadata: {
                        source: 'LNMTL.com',
                        fetchedAt: new Date().toISOString(),
                        totalPages: TOTAL_PAGES,
                        totalNovels: allNovels.length,
                        selectedNovels: selectedNovels.length
                    },
                    novels: selectedNovels
                };
                
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `lnmtl_novels_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log(`‚úÖ Downloaded ${selectedNovels.length} novels as JSON`, 'success');
                
            } catch (error) {
                log(`‚úó Error downloading JSON: ${error.message}`, 'error');
            }
        }

        // Create EPUB (simplified version)
        async function createEpub() {
            if (selectedNovels.length === 0) {
                log('No novels selected for EPUB creation', 'error');
                return;
            }
            
            try {
                log('Starting EPUB creation...', 'info');
                showProgress(true);
                updateProgress(0, selectedNovels.length, 'Creating EPUB...');
                
                // This is a simplified version - in reality, you would use a proper EPUB library
                const epubContent = generateEpubContent(selectedNovels);
                const blob = new Blob([epubContent], { type: 'application/epub+zip' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `lnmtl_novels_${new Date().toISOString().split('T')[0]}.epub`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log(`‚úÖ EPUB created with ${selectedNovels.length} novels`, 'success');
                
            } catch (error) {
                log(`‚úó Error creating EPUB: ${error.message}`, 'error');
            } finally {
                showProgress(false);
            }
        }

        // Generate simplified EPUB content
        function generateEpubContent(novels) {
            // This is a very basic EPUB structure
            // In a real implementation, you would use a library like JSZip and proper EPUB formatting
            
            let content = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
    <title>LNMTL Novels Collection</title>
    <meta charset="utf-8"/>
</head>
<body>
    <h1>LNMTL Novels Collection</h1>
    <p>Generated on: ${new Date().toLocaleDateString()}</p>
    <p>Total novels: ${novels.length}</p>
    
    <h2>Table of Contents</h2>
    <ul>`;
            
            novels.forEach((novel, index) => {
                content += `
        <li>
            <a href="#novel${index}">${novel.title} by ${novel.author}</a>
        </li>`;
            });
            
            content += `
    </ul>
    
    <hr/>`;
            
            novels.forEach((novel, index) => {
                content += `
    <div id="novel${index}">
        <h2>${novel.title}</h2>
        <h3>by ${novel.author}</h3>
        
        <p><strong>Published:</strong> ${novel.date}</p>
        <p><strong>Likes:</strong> ${novel.likes}</p>
        <p><strong>Ratings:</strong> üëç ${novel.ratings.positive} | üòê ${novel.ratings.neutral} | üëé ${novel.ratings.negative}</p>
        
        <p><strong>Genres:</strong> ${novel.genres.join(', ')}</p>
        <p><strong>Tags:</strong> ${novel.tags.join(', ')}</p>
        
        <h4>Description</h4>
        <p>${novel.description}</p>
        
        <hr/>
    </div>`;
            });
            
            content += `
</body>
</html>`;
            
            return content;
        }

        // Main fetch function
        async function fetchNovels() {
            try {
                document.getElementById('fetchBtn').disabled = true;
                await fetchAllPages();
            } catch (error) {
                log(`‚úó Fatal error: ${error.message}`, 'error');
                showProgress(false);
            } finally {
                document.getElementById('fetchBtn').disabled = false;
            }
        }

        // Initialize
        log('LNMTL Novel Crawler initialized', 'info');
        log('Enter a LNMTL URL and click "Fetch All Novels" to begin', 'info');
    </script>
</body>
</html>
