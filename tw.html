<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Novel Crawler with Translation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #fafafa;
    }
    #console, #console-translate {
      background: #111;
      color: #0f0;
      padding: 15px;
      border-radius: 4px;
      font-family: "Courier New", Courier, monospace;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 20px;
    }
    #console-translate {
      background: #f0f0ff;
      color: #000;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
    }
    #progressContainer {
      display: none;
      margin-top: 10px;
    }
    #progressBar {
      height: 20px;
      background: #0f0;
      width: 0%;
    }
    pre span[translate="no"] {
      color: darkred;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Novel Crawler</h2>

  <input id="novelUrl" type="text" placeholder="Enter novel URL" style="width:400px;">
  <button id="crawlBtn">Crawl Novel</button>
  <button id="fetchChaptersBtn" disabled>Fetch Chapters</button>
  <button id="downloadBtn" disabled>Download TXT</button>
  <button id="saveToJsonBtn" disabled>Save to JSON</button>
  <button id="saveTranslationBtn" disabled>Save Translation</button>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>

  <div id="console"></div>
  <pre id="console-translate"></pre>

  <script>
    const crawlBtn = document.getElementById('crawlBtn');
    const fetchChaptersBtn = document.getElementById('fetchChaptersBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const saveToJsonBtn = document.getElementById('saveToJsonBtn');
    const saveTranslationBtn = document.getElementById('saveTranslationBtn');
    const consoleDiv = document.getElementById('console');
    const consoleTranslate = document.getElementById('console-translate');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');

    let novelData = { title: '', author: '', chapters: [] };
    let currentBatchIndex = 0;
    const batchSize = 100;

    // Logging utility
    function log(msg, color="lime") {
      consoleDiv.innerHTML += `<span style="color:${color}">${msg}</span>\n`;
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function updateProgress(done, total) {
      const pct = Math.floor((done/total)*100);
      progressBar.style.width = pct + "%";
    }

    // Crawl metadata (dummy example)
    async function crawlNovel() {
      const url = document.getElementById('novelUrl').value.trim();
      if (!url) return alert("Enter a novel URL");
      log(`Crawling ${url} ...`);

      // Simulated chapters
      novelData = {
        title: "示例小说",
        author: "作者名",
        chapters: Array.from({length: 350}, (_,i)=>({
          title: `第${i+1}章`,
          url: `https://example.com/chapter/${i+1}`
        }))
      };
      log(`Found ${novelData.chapters.length} chapters.`);
      fetchChaptersBtn.disabled = false;
    }

    // Simulated fetch
    async function fetchChapterContent(url) {
      return new Promise(res=>setTimeout(()=>{
        res({ content: "这是章节内容 ..." });
      },100));
    }

    // Show JSON but lock keys
    function showTranslateJson(batch) {
      let text = JSON.stringify(batch, null, 2);
      // highlight and protect keys
      text = text.replace(/"title"/g, '<span translate="no">"title"</span>')
                 .replace(/"content"/g, '<span translate="no">"content"</span>');
      consoleTranslate.innerHTML = text;
      saveTranslationBtn.disabled = false;
    }

    // Fetch all chapters in batches
    async function fetchChapters() {
      if (!novelData.chapters.length) return alert("No chapters found");
      fetchChaptersBtn.disabled = true;
      progressContainer.style.display = "block";
      currentBatchIndex = 0;
      await fetchNextBatch();
    }

    async function fetchNextBatch() {
      const total = novelData.chapters.length;
      const start = currentBatchIndex * batchSize;
      const end = Math.min(start + batchSize, total);

      if (start >= total) {
        log("\n✅ All chapters processed!", "green");
        downloadBtn.disabled = false;
        saveToJsonBtn.disabled = false;
        progressContainer.style.display = "none";
        saveTranslationBtn.disabled = true;
        return;
      }

      log(`\nFetching batch ${currentBatchIndex+1}: chapters ${start+1}-${end}`);
      const slice = novelData.chapters.slice(start, end);

      const promises = slice.map(async (ch, idx)=>{
        log(`Fetching ${start+idx+1}/${total} - ${ch.title}`);
        const data = await fetchChapterContent(ch.url);
        return {...ch, ...data};
      });

      const results = await Promise.all(promises);
      results.forEach((r,i)=>novelData.chapters[start+i]=r);

      updateProgress(end,total);
      showTranslateJson(results);
    }

    // Save translations
    saveTranslationBtn.addEventListener('click', () => {
      try {
        // Remove spans, keep valid JSON
        let translatedText = consoleTranslate.textContent.trim();
        if (!translatedText) return alert("No translated text");

        const translatedJson = JSON.parse(translatedText);
        const start = currentBatchIndex * batchSize;

        for (let i=0; i<translatedJson.length; i++) {
          novelData.chapters[start+i] = {
            ...novelData.chapters[start+i],
            title: translatedJson[i].title,
            content: translatedJson[i].content
          };
        }

        log(`✅ Saved translation for batch ${currentBatchIndex+1}`, "green");
        saveTranslationBtn.disabled = true;
        currentBatchIndex++;
        fetchNextBatch();
      } catch(err) {
        log(`Error parsing translation JSON: ${err.message}`, "red");
      }
    });

    // Download TXT
    function downloadTXT() {
      const txt = novelData.chapters.map(c=>`${c.title}\n${c.content}\n`).join("\n\n");
      const blob = new Blob([txt], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = novelData.title+".txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Save to JSON file
    function saveToJson() {
      const blob = new Blob([JSON.stringify(novelData,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = novelData.title+".json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Event listeners
    crawlBtn.addEventListener('click', crawlNovel);
    fetchChaptersBtn.addEventListener('click', fetchChapters);
    downloadBtn.addEventListener('click', downloadTXT);
    saveToJsonBtn.addEventListener('click', saveToJson);
  </script>
</body>
</html>
