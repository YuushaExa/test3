<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gemini Translator</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    textarea { width: 100%; height: 150px; }
    button { margin: 0.5em 0; }
    select { margin: 0.5em; }
    pre { background: #eee; padding: 1em; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>Gemini Translator</h2>

  <label>Choose Gemini Key:
    <select id="keySelect">
      <option value="Key1">Key1</option>
      <option value="Key2">Key2</option>
      <option value="Key3">Key3</option>
      <option value="Key4">Key4</option>
    </select>
  </label>

  <label>Dispatch Interval:
    <select id="intervalSelect">
      <option value="4000">4s</option>
      <option value="8000">8s</option>
      <option value="12000">12s</option>
    </select>
  </label>

  <br>

  <textarea id="input" placeholder="Paste your JSON array of items here"></textarea>
  <br>
  <button id="startBtn">Start Translation</button>
  <button id="downloadBtn" disabled>Download Results</button>

  <h3>Logs</h3>
  <pre id="logs"></pre>

  <script>
    const WORKER_URL = "https://curly-pond-translate.yuush.workers.dev";

    let items = [];
    let translatedResults = [];

    function log(msg) {
      const logs = document.getElementById("logs");
      logs.textContent += msg + "\n";
      logs.scrollTop = logs.scrollHeight;
    }

    document.getElementById("startBtn").addEventListener("click", () => {
      try {
        items = JSON.parse(document.getElementById("input").value);
      } catch (err) {
        return log("❌ Invalid JSON input");
      }

      translatedResults = [];
      document.getElementById("downloadBtn").disabled = true;

      const keyId = document.getElementById("keySelect").value;
      const interval = parseInt(document.getElementById("intervalSelect").value, 10);

      log(`🚀 Starting translation, interval = ${interval/1000}s, using ${keyId}`);
      dispatchPipeline(items, keyId, interval);
    });

    function dispatchPipeline(items, keyId, interval) {
      let i = 0;

      function dispatchNext() {
        if (i >= items.length) return;

        const item = items[i];
        log(`[${i+1}/${items.length}] Sending: ${item.title}`);
        i++;

        (async () => {
          try {
            const res = await fetch(`${WORKER_URL}/translate`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ item, modelName: "gemini-1.5-flash", keyId })
            });

            if (!res.ok) throw new Error(await res.text());

            const result = await res.json();
            translatedResults.push(result);
            log(`✅ Finished: ${item.title}`);

            if (translatedResults.length === items.length) {
              document.getElementById("downloadBtn").disabled = false;
              log("🎉 All translations complete!");
            }
          } catch (err) {
            translatedResults.push({ ...item, error: err.message });
            log(`❌ Error: ${err.message}`);
          }
        })();
      }

      dispatchNext(); // first immediately
      const timer = setInterval(() => {
        if (i >= items.length) {
          clearInterval(timer);
        } else {
          dispatchNext();
        }
      }, interval);
    }

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(translatedResults, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "translated.json";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
