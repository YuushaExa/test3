<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSON Translator</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;max-width:800px;margin:0 auto;padding:20px;background:#f5f5f5}
    h1{color:#333;text-align:center}
    .container{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .form-group{margin-bottom:15px}
    label{display:block;margin-bottom:5px;font-weight:bold}
    input[type=text],input[type=file],select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box}
    button{background:#4CAF50;color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;font-size:16px;margin-right:10px}
    button:disabled{background:#ccc}
    #console{background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:4px;font-family:'Courier New',Courier,monospace;height:300px;overflow-y:auto;white-space:pre-wrap;margin-top:20px}
    .log-line{margin:0;padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
    .progress-container{margin-top:15px;display:none}
    progress{width:100%}
    .status{text-align:center;margin:10px 0;font-weight:bold}
  </style>
</head>
<body>
  <h1>JSON Translator</h1>
  <div class="container">
    <div class="form-group">
      <label for="fileInput">Upload JSON File:</label>
      <input type="file" id="fileInput" accept=".json" />
    </div>

    <div class="form-group">
      <label for="urlInput">Or Enter JSON URL:</label>
      <input type="text" id="urlInput" placeholder="https://example.com/data.json" />
    </div>

    <div class="form-group">
      <label for="rangeInput">Range (e.g. 1-10):</label>
      <input type="text" id="rangeInput" value="1-10" />
    </div>

    <div class="form-group">
      <label for="modelName">MODEL_NAME:</label>
      <select id="modelName">
        <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
        <option value="gemini-2.5-pro">gemini-2.5-pro</option>
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
      </select>
    </div>

    <div class="form-group">
      <label for="titleModel">TITLE_MODEL:</label>
      <select id="titleModel">
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
        <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
      </select>
    </div>

    <div class="form-group">
      <label for="delaySelect">Translation Delay (ms):</label>
      <select id="delaySelect">
        <option value="4000" selected>4000 ms</option>
        <option value="8000">8000 ms</option>
        <option value="12000">12000 ms</option>
      </select>
    </div>

    <button id="startBtn">Start Translation</button>
    <button id="downloadBtn" disabled>Download Result</button>

    <div class="progress-container" id="progressContainer">
      <div class="status" id="statusText">Processing...</div>
      <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <div id="console"></div>
  </div>

<script>
const WORKER_URL = "https://curly-pond-translate.yuush.workers.dev";
let translatedResults = [];

function log(msg) {
  const consoleBox = document.getElementById("console");
  const line = document.createElement("div");
  line.className = "log-line";
  line.textContent = msg;
  consoleBox.appendChild(line);
  consoleBox.scrollTop = consoleBox.scrollHeight;
}

function parseRange(rangeStr, max) {
  let [start, end] = rangeStr.split("-").map(Number);
  if (!start) start = 1;
  if (!end) end = max;
  if (start > end) [start, end] = [end, start];
  return { start, end };
}

async function loadJsonData() {
  const file = document.getElementById("fileInput").files[0];
  const url = document.getElementById("urlInput").value.trim();

  if (file) {
    return JSON.parse(await file.text());
  } else if (url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to fetch JSON from URL (${res.status})`);
    return await res.json();
  } else {
    throw new Error("Please upload a file or provide a JSON URL");
  }
}

function getTranslationDelay() {
  return parseInt(document.getElementById("delaySelect").value, 10);
}

document.getElementById("startBtn").onclick = async () => {
  document.getElementById("console").innerHTML = "";
  document.getElementById("progressContainer").style.display = "block";
  document.getElementById("progressBar").value = 0;
  document.getElementById("downloadBtn").disabled = true;

  try {
    let data = await loadJsonData();

let fullResults = [...data]; // start with original JSON
let translatedResults = new Array(data.length); // preserve original size

const { start, end } = parseRange(
  document.getElementById("rangeInput").value,
  data.length
);
const items = data.slice(start - 1, end);


    const modelName = document.getElementById("modelName").value;
    const titleModel = document.getElementById("titleModel").value;

    log(`Processing items ${start}-${end} of ${data.length}`);

    // 1Ô∏è‚É£ Batch title translation
    let translatedTitles = [];
    for (let i = 0; i < items.length; i += 50) {
      const batch = items.slice(i, i + 50).map(it => it.title);
      log(`Batch translating titles ${i + 1}-${i + batch.length}...`);

      try {
        const res = await fetch(`${WORKER_URL}/translateTitles`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ titles: batch, titleModel })
        });
        if (!res.ok) throw new Error(await res.text());
        const result = await res.json();
        translatedTitles.push(...result.titles);
      } catch (err) {
        log(`‚ùå Error in batch title translation: ${err.message}`);
        translatedTitles.push(...batch);
      }
    }

    for (let i = 0; i < items.length; i++) {
      items[i].title = translatedTitles[i] || items[i].title;
    }

    // 2Ô∏è‚É£ Content translation (ordered)
    translatedResults = new Array(items.length); // pre-allocate
    let completed = 0;
    let index = 0;

    function updateProgress() {
      const percent = Math.round((completed / items.length) * 100);
      document.getElementById("progressBar").value = percent;
      document.getElementById("statusText").textContent = `${percent}% Completed`;
    }

    function dispatchNext() {
      if (index >= items.length) return;

      const item = items[index];
      const currentIndex = index; // preserve order
      log(`[${currentIndex + 1}/${items.length}] Sending: ${item.title}`);
      index++;

      (async () => {
        try {
          const res = await fetch(`${WORKER_URL}/translate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ item, modelName })
          });

          if (!res.ok) throw new Error(await res.text());

          const result = await res.json();
          translatedResults[currentIndex] = result; // keep order
          log(`‚úÖ Finished: ${item.title.substring(0, 50)}...`);
        } catch (err) {
          log(`‚ùå Error: ${err.message}`);
          translatedResults[currentIndex] = { ...item, error: err.message }; // keep position
        } finally {
          completed++;
          updateProgress();
          if (completed === items.length) {
            document.getElementById("downloadBtn").disabled = false;
            log("üéâ All translations complete!");
          }
        }
      })();
    }

    dispatchNext();
    const timer = setInterval(() => {
      if (index >= items.length) {
        clearInterval(timer);
      } else {
        dispatchNext();
      }
    }, getTranslationDelay());

  } catch (err) {
    log(`‚ùå ${err.message}`);
  }
};

document.getElementById("downloadBtn").onclick = () => {
  const finalJson = translatedResults.map((res, i) => res || data[i]); 
  const blob = new Blob([JSON.stringify(finalJson, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "translated.json";
  a.click();
  URL.revokeObjectURL(url);
};

</script>
</body>
</html>
